name: Reusable Minimal Widget CI
permissions:
  contents: write
  id-token: write

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        default: "22"
      base-branch:
        type: string
        default: "main"
    secrets:
      PRIVATE_KEY_FOR_1FE: { required: true }
      PRIVATE_KEY_FOR_WIDGET_BASE_CONFIG: { required: true }
      AKAMAI_NS_SSH_PRIVATE_KEY: { required: true }
      AZURE_APP_CONFIG_CONNECTION_STRING: { required: true }

jobs:
  build:
    uses: ./.github/workflows/reusable-widget-build.yml
    with:
      node-version: ${{ inputs.node-version }}
      base-branch: ${{ inputs.base-branch }}
    secrets:
      PRIVATE_KEY_FOR_1FE: ${{ secrets.PRIVATE_KEY_FOR_1FE }}
      PRIVATE_KEY_FOR_WIDGET_BASE_CONFIG: ${{ secrets.PRIVATE_KEY_FOR_WIDGET_BASE_CONFIG }}
      AKAMAI_NS_SSH_PRIVATE_KEY: ${{ secrets.AKAMAI_NS_SSH_PRIVATE_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  tests:
    uses: ./.github/workflows/reusable-widget-tests.yml
    needs: build
    with:
      node-version: ${{ inputs.node-version }}
    secrets:
      PRIVATE_KEY_FOR_1FE: ${{ secrets.PRIVATE_KEY_FOR_1FE }}
      PRIVATE_KEY_FOR_WIDGET_BASE_CONFIG: ${{ secrets.PRIVATE_KEY_FOR_WIDGET_BASE_CONFIG }}

  release-integration:
    needs: [build, tests]
    if: github.ref_name == inputs.base-branch
    uses: ./.github/workflows/reusable-update-azure-config.yml
    with:
      environment: integration
      widgetId: ${{ needs.build.outputs.widgetId }}
      nextVersion: ${{ needs.build.outputs.nextVersion }}
    secrets:
      AZURE_APP_CONFIG_CONNECTION_STRING: ${{ secrets.AZURE_APP_CONFIG_CONNECTION_STRING }}

  upload-production:
    needs: [build, release-integration]
    if: github.ref_name == inputs.base-branch
    uses: ./.github/workflows/reusable-widget-upload-production.yml
    with:
      widgetId: ${{ needs.build.outputs.widgetId }}
      nextVersion: ${{ needs.build.outputs.nextVersion }}
    secrets:
      AKAMAI_NS_SSH_PRIVATE_KEY: ${{ secrets.AKAMAI_NS_SSH_PRIVATE_KEY }}

  approve-production-release:
    needs: upload-production
    if: github.ref_name == inputs.base-branch
    environment: production-release
    runs-on: ubuntu-latest
    steps:
      - run: echo "Production release approved."

  release-production:
    needs: [build, approve-production-release]
    if: github.ref_name == inputs.base-branch
    uses: ./.github/workflows/reusable-update-azure-config.yml
    with:
      environment: production
      widgetId: ${{ needs.build.outputs.widgetId }}
      nextVersion: ${{ needs.build.outputs.nextVersion }}
    secrets:
      AZURE_APP_CONFIG_CONNECTION_STRING: ${{ secrets.AZURE_APP_CONFIG_CONNECTION_STRING }}
